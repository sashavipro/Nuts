{% extends "base.html" %}
{% load i18n django_vite wagtailcore_tags wagtailimages_tags %}

{% block extra_css %}
<style>
    /* --- СТАРЫЕ СТИЛИ ОСТАВЛЯЕМ БЕЗ ИЗМЕНЕНИЙ --- */
    .stickers-container { position: absolute; top: 20px; left: -9px; z-index: 20; display: flex; flex-direction: column; gap: 5px; }
    .product__item .sticker { position: relative !important; top: auto !important; left: auto !important; margin: 0 !important; transform: none !important; }
    .zoom-icon-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 5; pointer-events: none; opacity: 0.7; }
    .product__item > .zoom, .products-container > .zoom { display: none !important; }
    .zoomLens { border: 1px solid #82b440 !important; background-color: rgba(255, 255, 255, 0.4); cursor: crosshair; }
    .zoomContainer { z-index: 999; }
    .product__item .products-container { width: 100%; height: 500px; margin: 0 auto; position: relative; overflow: hidden; }
    .product__item .swiper-slide { display: flex; justify-content: center; align-items: center; background: #fff; height: 100%; width: 100%; }
    .product__item .main-image { max-width: 100%; max-height: 100%; width: auto; height: auto; object-fit: contain; display: block; }
    .product__item .swiper-button-prev, .product__item .swiper-button-next { width: 50px; height: 50px; margin-top: 0; top: 50%; transform: translateY(-50%); outline: none; z-index: 30; }
    .product__item .swiper-button-prev { left: 10px !important; }
    .product__item .swiper-button-next { right: 10px !important; }
    .product__item .swiper-button-prev:after, .product__item .swiper-button-next:after { color: #b5b5b5; font-size: 28px !important; font-weight: bold; }
    .product__item .swiper-button-prev:hover:after, .product__item .swiper-button-next:hover:after { color: #337d5a; }
    @media (max-width: 767px) { .product__item .products-container { height: 350px; } }

    /* --- НОВЫЕ СТИЛИ ДЛЯ ШАПКИ ТОВАРА --- */
    .product-header-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 5px; }
    .product-title-green { color: #337d5a; font-weight: 700; font-size: 28px; margin: 0; line-height: 1.2; margin-right: 20px; flex-grow: 1; }
    .product-sku { color: #888; font-weight: normal; font-size: 14px; white-space: nowrap; }
    .product-taste-black { font-size: 24px; font-weight: 700; color: #1d252d; margin-bottom: 25px; line-height: 1.2; }
    .product-attributes { width: 100%; margin-bottom: 30px; }
    .attr-row { display: flex; padding: 12px 0; border-bottom: 1px solid #eee; }
    .attr-name { width: 40%; font-weight: 700; color: #1d252d; }
    .attr-val { width: 60%; color: #555; }
    .product-warning { background: #fcfcfc; border: 1px solid #eee; padding: 20px; display: flex; align-items: center; gap: 15px; margin-bottom: 30px; }
    .product-warning .icon { width: 30px; height: 30px; background: #82b440; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: white; font-weight: bold; flex-shrink: 0; }
    .product-price-block { display: flex; justify-content: flex-end; align-items: center; gap: 20px; }
    .price-label { font-weight: 700; font-size: 18px; }
    .current-price { font-size: 28px; font-weight: 700; color: #337d5a; }
    .old-price { text-decoration: line-through; color: #aaa; font-size: 16px; margin-left: 10px; }
</style>
{% endblock %}

{% block content %}
<section class="product">
    <div class="container">
        <div class="row no-gutters">

            {# --- ЛЕВАЯ КОЛОНКА: ФОТО --- #}
            <div class="col-lg-5 col-md-6">
                <div class="wrap">
                    <div class="product__item">
                        <div class="stickers-container">
                            {% if product.is_sale %}
                                <div class="sticker"><i class="nut-icon icons-actciya"></i><p>{% trans "Акция" %}</p></div>
                            {% endif %}
                            {% if product.is_new %}
                                <div class="sticker"><i class="nut-icon icons-novinka"></i><p>{% trans "Новинка" %}</p></div>
                            {% endif %}
                        </div>

                        <div class="products-container swiper-container">
                            <div class="swiper-wrapper">
                                {% for item in product.gallery_images.all %}
                                    <div class="swiper-slide">
                                        {% image item.image original as full_img %}
                                        {% image item.image max-1000x1000 class="img-fluid main-image" data-zoom-image=full_img.url %}
                                    </div>
                                {% empty %}
                                    <div class="swiper-slide">
                                        <img src="{% vite_asset_url 'app/img/placeholder.jpg' %}" alt="placeholder" class="img-fluid main-image">
                                    </div>
                                {% endfor %}
                            </div>
                            {% if product.gallery_images.count > 1 %}
                                <div class="swiper-button-prev"></div>
                                <div class="swiper-button-next"></div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            {# --- ПРАВАЯ КОЛОНКА: ИНФО О ТОВАРЕ --- #}
            <div class="col-lg-7 col-md-6">
                <div class="product__content" style="padding-left: 40px;">

                    <div class="product-header-row">
                        <h1 class="product-title-green">{{ product.title }}</h1>
                        <span class="product-sku">{% trans "Арт" %}: {{ product.sku }}</span>
                    </div>

                    <div class="product-taste-black">
                        {% if product.tastes.first %}{{ product.tastes.first.name }}{% endif %}
                    </div>

                    <div class="product-attributes">
                        {% if product.composition %}
                        <div class="attr-row">
                            <div class="attr-name">{% trans "Состав" %}:</div>
                            <div class="attr-val">{{ product.composition }}</div>
                        </div>
                        {% endif %}

                        {% if product.weight_option %}
                        <div class="attr-row">
                            <div class="attr-name">{% trans "Масса нетто" %}:</div>
                            <div class="attr-val">{{ product.weight_option.name }}</div>
                        </div>
                        {% endif %}

                        {% if product.energy_value %}
                        <div class="attr-row">
                            <div class="attr-name">{% trans "Энергетическая ценность" %}:</div>
                            <div class="attr-val">{{ product.energy_value }}</div>
                        </div>
                        {% endif %}

                        {% if product.shelf_life %}
                        <div class="attr-row">
                            <div class="attr-name">{% trans "Срок годности" %}:</div>
                            <div class="attr-val">{{ product.shelf_life }}</div>
                        </div>
                        {% endif %}
                    </div>

                    {% if product.storage_conditions %}
                    <div class="product-warning">
                        <div class="icon">!</div>
                        <div>{{ product.storage_conditions }}</div>
                    </div>
                    {% endif %}

                    <div class="product-price-block">
                        <div class="price-label">{% trans "Ваша цена" %}:</div>
                        <div>
                            <span class="current-price">{{ product.price }} {% trans "грн." %}</span>
                            {% if product.old_price %}
                                <span class="old-price">{{ product.old_price }} {% trans "грн." %}</span>
                            {% endif %}
                        </div>
                        <a href="#" class="button button-green" style="margin-left: 20px;">{% trans "Заказать" %}</a>
                    </div>

                </div>
            </div>
        </div>
    </div>
</section>

{% if page %}
    {% for block in page.body %}
        {% include_block block %}
    {% endfor %}

    {% for block in page.footer_blocks %}
        {% include_block block %}
    {% endfor %}
{% endif %}

{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/elevatezoom/2.2.3/jquery.elevatezoom.min.js" integrity="sha512-UH428GPLVbCa8xDVryhlGugrQFqAivETqIqrQrpBeimiuuuCR5F/0XXQsmEUK5XUg/yOQII39dM5Jt2T0h+cbQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
    function initZoomForSlider(sliderElement) {
        var activeSlide = sliderElement.querySelector('.swiper-slide-active:not(.swiper-slide-duplicate)');
        if (!activeSlide) activeSlide = sliderElement.querySelector('.swiper-slide-active');
        if (!activeSlide) activeSlide = sliderElement.querySelector('.swiper-slide:not(.swiper-slide-duplicate)');

        if (activeSlide) {
            var img = $(activeSlide).find('.main-image');
            $('.zoomContainer').remove();
            $('.main-image').removeData('elevateZoom');

            if (img.length > 0) {
                img.elevateZoom({
                    zoomType: "lens",
                    lensShape: "round",
                    lensSize: 200,
                    borderSize: 1,
                    borderColor: "#82b440",
                    containLensZoom: true
                });
            }
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        var productSlider = document.querySelector('.products-container');
        if (!productSlider || !productSlider.swiper) return;

        var swiperInstance = productSlider.swiper;

        $(productSlider).on('mouseenter', function() { initZoomForSlider(productSlider); });
        $(productSlider).on('mouseleave', function() { $('.zoomContainer').remove(); });

        swiperInstance.on('slideChange', function() { $('.zoomContainer').remove(); });
        swiperInstance.on('slideChangeTransitionEnd', function() { initZoomForSlider(productSlider); });
    });
</script>
{% endblock %}
