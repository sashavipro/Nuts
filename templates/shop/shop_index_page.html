{% extends "base.html" %}
{% load i18n django_vite wagtailcore_tags wagtailimages_tags navigation_tags %}

{% block body_class %}page inside{% endblock %}
{% block extra_css %}
<style>
    .select2-container { width: 100% !important; }
    .select2-container--default .select2-selection--single { height: 48px !important; border: 1px solid #e2e2e2 !important; border-radius: 0 !important; background-color: #fff !important; display: flex !important; align-items: center !important; outline: none !important; box-shadow: none !important; transition: border-color 0.2s ease !important; }
    .select2-container--default .select2-selection--single .select2-selection__rendered { color: #1b1b1b !important; font-size: 16px !important; padding-left: 15px !important; line-height: normal !important; }
    .select2-container--default .select2-selection--single .select2-selection__arrow { height: 100% !important; width: 40px !important; position: absolute !important; right: 0 !important; top: 0 !important; display: flex !important; align-items: center !important; justify-content: center !important; }
    .select2-container--default .select2-selection--single .select2-selection__arrow b { display: none !important; }
    .select2-container--default .select2-selection--single .select2-selection__arrow::after { content: ''; display: inline-block; width: 8px; height: 8px; border-right: 2px solid #888; border-bottom: 2px solid #888; transform: rotate(45deg); transition: all 0.2s ease; margin-top: -4px; }
    .select2-container--default:hover .select2-selection--single { border-color: #337D5A !important; }
    .select2-container--default:hover .select2-selection--single .select2-selection__arrow::after { border-color: #337D5A !important; }
    .select2-container--default.select2-container--open .select2-selection--single { border-color: #337D5A !important; border-bottom-color: transparent !important; }
    .select2-container--default.select2-container--open .select2-selection--single .select2-selection__arrow::after { transform: rotate(225deg); margin-top: 4px; border-color: #337D5A !important; }
    .select2-container--default .select2-dropdown { border: 1px solid #337D5A !important; border-top: none !important; border-radius: 0 !important; box-shadow: none !important; margin-top: 0 !important; }
    .select2-container--default .select2-results__option { padding: 10px 15px !important; font-size: 16px !important; color: #1b1b1b !important; background-color: #fff !important; cursor: pointer !important; transition: background 0.1s ease, color 0.1s ease; }
    .select2-container--default .select2-results__option--highlighted.select2-results__option--selectable,
    .select2-container--default .select2-results__option--highlighted[aria-selected],
    .select2-container--default .select2-results__option:hover { background-color: #337D5A !important; color: #fff !important; }
    .select2-container--default .select2-results__option[aria-selected="true"] { background-color: #f5f5f5 !important; color: #1b1b1b !important; }
    .select2-container--default .select2-results__option[aria-selected="true"]:hover,
    .select2-container--default .select2-results__option--highlighted[aria-selected="true"] { background-color: #337D5A !important; color: #fff !important; }
</style>
{% endblock %}

{% block content %}
{% for block in page.body %}
    {% include_block block %}
{% endfor %}

<section class="production">
    <div class="container">
        <div class="row align-items-center justify-content-center">
            <div class="col-12">
                <div class="production__filter">
                    <form id="filter-form" action="." method="get">
                        <div class="row">
                            <div class="col-lg-7">
                                <div class="row align-items-center">
                                    <div class="col-lg-3">
                                        <div class="production__filter_title">
                                            <p>{% trans "Фильтр" %}</p>
                                            <i class="nut-icon icons-settings"></i>
                                        </div>
                                    </div>

                                    <div class="col-lg-5">
                                        <select name="taste" class="wide">
                                            <option value="">{% trans "Вкус" %}</option>
                                            {% for taste in tastes %}
                                                <option value="{{ taste.id }}" {% if current_taste == taste.id %}selected{% endif %}>
                                                    {{ taste.name }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <div class="col-lg-4">
                                        <select name="weight" class="wide">
                                            <option value="">{% trans "Масса" %}</option>
                                            {% for weight in weights %}
                                                <option value="{{ weight.id }}" {% if current_weight == weight.id %}selected{% endif %}>
                                                    {{ weight.name }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="col-lg-5 align-self-center">
                                <div class="row">
                                    <div class="col-lg-5 align-self-center">
                                        <div class="production__filter_price" style="cursor: pointer; user-select: none;">
                                            <span>{% trans "Стоимость" %}</span>
                                            <input type="hidden" name="sort" id="sort-input" value="{{ current_sort }}">
                                            <i class="nut-icon icons-arrow-down {% if current_sort == 'price_desc' %}accent{% endif %}" data-sort="price_desc"></i>
                                            <i class="nut-icon icons-right-top {% if current_sort == 'price_asc' %}accent{% endif %}" data-sort="price_asc"></i>
                                        </div>
                                    </div>

                                    <div class="col-lg-7">
                                        <div class="production__filter_button">
                                            <a href="#" class="button" id="apply-filters">{% trans "Применить" %}</a>
                                            <a href="#" class="button_close" id="reset-filters">
                                                <i class="nut-icon icons-close-button"></i><span> {% trans "Сбросить" %}</span>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="row justify-content-center" id="product-grid">
            {% include "shop/includes/product_list.html" %}
        </div>

    </div>
</section>

{% for block in page.footer_blocks %}
    {% include_block block %}
{% endfor %}

{% endblock %}

{% block extra_js %}
<script>
    function fetchFilteredProducts() {
        var url = '{{ page.url }}?' + $('#filter-form').serialize();
        history.pushState(null, '', url);
        htmx.ajax('GET', url, { target: '#product-grid', swap: 'innerHTML' });
    }

    window.addEventListener('load', function() {
        if ($.fn.select2) {
            $('select.wide').select2({
                minimumResultsForSearch: Infinity,
                width: '100%'
            });
        }

        $('select.wide').on('change', function() {
            fetchFilteredProducts();
        });

        $('.production__filter_price').on('click', function(e) {
            let targetSort = 'price_asc';
            if (e.target.hasAttribute('data-sort')) {
                targetSort = $(e.target).attr('data-sort');
            } else {
                targetSort = $('#sort-input').val() === 'price_asc' ? 'price_desc' : 'price_asc';
            }
            $('#sort-input').val(targetSort);
            $('.production__filter_price i').removeClass('accent');
            $('.production__filter_price i[data-sort="' + targetSort + '"]').addClass('accent');
            fetchFilteredProducts();
        });

        $('#apply-filters').on('click', function(e) {
            e.preventDefault();
            fetchFilteredProducts();
        });

        $('#reset-filters').on('click', function(e) {
            e.preventDefault();
            $('#filter-form')[0].reset();
            $('#sort-input').val('default');
            $('.production__filter_price i').removeClass('accent');
            if ($.fn.select2) {
                $('select.wide').val('').trigger('change.select2');
            }
            fetchFilteredProducts();
        });

        initShopScripts();
    });

    document.addEventListener('htmx:afterSettle', function(evt) {
        if (evt.detail.target.id === 'product-grid' || evt.detail.target.id === 'shop-load-more-container') {
            initShopScripts();
        }
    });

    function initShopScripts() {
        if (typeof Swiper !== 'undefined') {
            $('.product-list-swiper:not(.swiper-container-initialized)').each(function() {
                var slidesCount = $(this).find('.swiper-slide').length;
                new Swiper(this, {
                    slidesPerView: 1,
                    spaceBetween: 0,
                    loop: slidesCount > 1,
                    navigation: {
                        nextEl: $(this).find('.swiper-button-next')[0],
                        prevEl: $(this).find('.swiper-button-prev')[0],
                    }
                });
            });
        }

        if (typeof $.fn.simpleLightbox !== 'undefined') {
            $('.products-container .swiper-slide a.lightbox-link').each(function() {
                if ($(this).data('simpleLightbox')) {
                    $(this).data('simpleLightbox').destroy();
                }
            });
            $('.products-container .swiper-slide a.lightbox-link').simpleLightbox();
        }

        $('.zoom-link').off('click').on('click', function(e) {
            e.preventDefault();
            $(this).closest('.products-container').find('.swiper-slide-active a.lightbox-link').trigger('click');
        });

        $('.production__item .wrap').off('click').on('click', function(e) {
            const isButton = $(e.target).closest('.button').length > 0;
            const isSlider = $(e.target).closest('.products-container').length > 0;
            const isLink = $(e.target).closest('a').length > 0;

            if (!isButton && !isSlider && !isLink) {
                var url = $(this).find('.production__item_title a').attr('href');
                if(url && url !== '#') {
                    window.location.href = url;
                }
            }
        });
    }
</script>
{% endblock %}
