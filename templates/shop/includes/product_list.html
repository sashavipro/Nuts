{% load i18n wagtailcore_tags wagtailimages_tags django_vite navigation_tags %}

<style>
    .zoomLens {
        border: 1px solid #82b440 !important;
        background-color: rgba(255, 255, 255, 0.4);
        cursor: crosshair;
    }
    .zoomContainer {
        z-index: 999;
    }
</style>

{% for product in products %}
<div class="col-lg-4 col-md-6 col-12 fade-in-item">
    <div class="wrap">
        <div class="production__item" style="position: relative;">

            <div class="badges-wrapper" style="position: absolute; top: 10px; left: 0; z-index: 10; display: flex; flex-direction: column; gap: 5px;">
                {% if product.is_sale %}
                    <div class="sticker" style="position: relative; margin: 0;">
                        <i class="nut-icon icons-actciya"></i>
                        <p>{% trans "Акция" %}</p>
                    </div>
                {% endif %}

                {% if product.is_new %}
                    <div class="sticker" style="position: relative; margin: 0;">
                        <i class="nut-icon icons-novinka"></i>
                        <p>{% trans "Новинка" %}</p>
                    </div>
                {% endif %}
            </div>

            <div class="products-container swiper-container product-list-swiper" id="swiper-{{ product.id }}">
                <div class="swiper-wrapper">
                    {% with gallery_images=product.get_gallery_images %}
                        {% if gallery_images %}
                            {% for gallery_image in gallery_images %}
                                <div class="swiper-slide">
                                    {% image gallery_image.image original as full_img %}
                                    {% image gallery_image.image fill-400x400 class="list-zoom-img" data-zoom-image=full_img.url style="width: 100%; height: 100%; object-fit: contain;" %}
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="swiper-slide">
                                <img src="{% vite_asset_url 'app/img/placeholder.jpg' %}" alt="{{ product.title }}" style="width: 100%; height: 100%; object-fit: contain;">
                            </div>
                        {% endif %}
                    {% endwith %}
                </div>

                {% if product.get_gallery_images.count > 1 %}
                    <div class="swiper-button-prev"></div>
                    <div class="swiper-button-next"></div>
                {% endif %}

                <div class="hover-elements">
                    <div class="zoom-link" style="pointer-events: none;">
                        <img class="zoom" src="{% vite_asset_url 'app/img/zoom.svg' %}" alt="zoom">
                    </div>
                </div>
            </div>

            <div class="wrap">
                <div class="production__item_title">
                    <a href="{% get_shop_url %}{{ product.slug }}/" style="color: inherit; text-decoration: none;">
                        {{ product.title }}
                    </a>
                </div>

                {% if product.sku %}
                <div class="production__item_art">
                    <span>{% trans "Арт" %}:</span> {{ product.sku }}
                </div>
                {% endif %}

                {% if product.tastes.exists %}
                <div class="production__item_tastes" style="margin-bottom: 10px; font-size: 14px; color: #000; font-weight: 600; padding: 0 20px;">
                    {% for taste in product.tastes.all %}
                        {{ taste.name }}{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                </div>
                {% endif %}

                <div class="production__item_weight">
                    <div class="weight_item">
                        <div class="weight_item_icon">
                            <i class="nut-icon icons-food-scale-tool"></i>
                        </div>
                        <div class="weight_item_descr">
                            <p>{% trans "Масса" %}</p>
                            <p><span>{{ product.weight_option.name|default:"—" }}</span></p>
                        </div>
                    </div>
                    {% if product.packaging %}
                    <div class="weight_item">
                        <div class="weight_item_icon">
                            <i class="nut-icon icons-group"></i>
                        </div>
                        <div class="weight_item_descr">
                            <p>{% trans "Упаковка" %}</p>
                            <p><span>{{ product.packaging }}</span></p>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <div class="production__item_sum">
                    <div class="sum_item">
                        <div class="sum_item_title">
                            <p>{% trans "Цена" %}: </p>
                        </div>
                        {% if product.old_price %}
                            <div class="sum_item_new">
                                <p>{{ product.price }} <i>{% trans "грн." %}</i></p>
                            </div>
                            <div class="sum_item_old">
                                <p>{{ product.old_price }} <i>{% trans "грн." %}</i></p>
                            </div>
                        {% else %}
                            <div class="sum_item_new">
                                <p>{{ product.price }} <i>{% trans "грн." %}</i></p>
                            </div>
                        {% endif %}
                    </div>
                    <div class="sum_item">
                        <div class="sum_item_button">
                            <button hx-post="/shop/api/cart/add/{{ product.id }}/"
                                    hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                                    hx-target="#cart-counter"
                                    hx-swap="outerHTML"
                                    class="button"
                                    style="border: none; cursor: pointer; width: 100%;">
                                {% trans "Купить" %}
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
{% endfor %}

{% if products.has_next %}
    <div id="shop-load-more-container" class="col-12 w-100 text-center" style="margin-top: 40px; margin-bottom: 20px;">
        <button class="button button-green"
                hx-get="?page={{ products.next_page_number }}{% if current_taste %}&taste={{ current_taste }}{% endif %}{% if current_weight %}&weight={{ current_weight }}{% endif %}{% if current_sort and current_sort != 'default' %}&sort={{ current_sort }}{% endif %}"
                hx-target="#shop-load-more-container"
                hx-swap="outerHTML"
                hx-indicator="#shop-loader"
                style="min-width: 250px; border: none; cursor: pointer;">
            {% trans "Показать еще" %}
        </button>

        <div id="shop-loader" class="htmx-indicator text-center" style="display:none; margin-top: 15px;">
            <i class="nut-icon icons-update" style="font-size: 24px; color: #337D5A; animation: spin 1s linear infinite;"></i>
        </div>
    </div>

    <style>
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
{% endif %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/elevatezoom/2.2.3/jquery.elevatezoom.min.js" integrity="sha512-UH428GPLVbCa8xDVryhlGugrQFqAivETqIqrQrpBeimiuuuCR5F/0XXQsmEUK5XUg/yOQII39dM5Jt2T0h+cbQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
    function initZoomForSlider(sliderElement) {
        var activeSlide = sliderElement.querySelector('.swiper-slide-active');
        if (!activeSlide) activeSlide = sliderElement.querySelector('.swiper-slide');

        if (activeSlide) {
            var img = $(activeSlide).find('.list-zoom-img');

            $('.zoomContainer').remove();
            $('.list-zoom-img').removeData('elevateZoom');

            if (img.length > 0) {
                img.elevateZoom({
                    zoomType: "lens",
                    lensShape: "round",
                    lensSize: 200,
                    borderSize: 1,
                    borderColor: "#82b440",
                    containLensZoom: true
                });
            }
        }
    }

    setTimeout(function() {
        if (typeof Swiper !== 'undefined') {
            var sliders = document.querySelectorAll('.product-list-swiper:not(.swiper-container-initialized)');

            sliders.forEach(function(slider) {
                var slidesCount = slider.querySelectorAll('.swiper-slide').length;

                new Swiper(slider, {
                    slidesPerView: 1,
                    spaceBetween: 0,
                    loop: slidesCount > 1,
                    simulateTouch: false,
                    observer: true,
                    observeParents: true,
                    navigation: {
                        nextEl: slider.querySelector('.swiper-button-next'),
                        prevEl: slider.querySelector('.swiper-button-prev'),
                    },
                    on: {
                        init: function() {
                            $(slider).on('mouseenter', function() {
                                initZoomForSlider(slider);
                            });
                        },
                        slideChangeTransitionEnd: function() {
                            initZoomForSlider(slider);
                        },
                        slideChange: function() {
                            $('.zoomContainer').remove();
                        }
                    }
                });
            });

            $('.product-list-swiper').each(function() {
                 var slider = this;
                 $(slider).on('mouseenter', function() {
                    initZoomForSlider(slider);
                 });
                 $(slider).on('mouseleave', function() {
                    $('.zoomContainer').remove();
                 });
            });
        }
    }, 100);

    if (typeof $ !== 'undefined' && $.fn.niceSelect) {
        $('select.wide').niceSelect();
    }
</script>
