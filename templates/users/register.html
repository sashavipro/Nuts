{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<!-- Подключаем Select2 -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<style>
    /* ========================================
       КАСТОМИЗАЦИЯ SELECT2
    ======================================== */

    /* Основной контейнер */
    .select2-container {
        width: 100% !important;
    }

    /* Поле выбора */
    .select2-container .select2-selection--single {
        height: 50px !important;
        border: 1px solid #e1e1e1 !important;
        border-radius: 0 !important;
        display: flex !important;
        align-items: center !important;
        background-color: #fff !important;
    }

    /* Стрелка */
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 48px !important;
        right: 10px !important;
    }

    /* Текст выбранного значения */
    .select2-container--default .select2-selection--single .select2-selection__rendered {
        color: #495057 !important;
        padding-left: 15px !important;
        font-size: 16px !important;
        line-height: 48px !important;
    }

    /* Placeholder */
    .select2-container--default .select2-selection--single .select2-selection__placeholder {
        color: #999 !important;
    }

    /* Фокус (зеленая рамка) */
    .select2-container--default.select2-container--focus .select2-selection--single,
    .select2-container--default.select2-container--open .select2-selection--single {
        border-color: #337d5a !important;
        outline: none !important;
        box-shadow: 0 0 0 0.2rem rgba(51, 125, 90, 0.25) !important;
    }

    /* Выпадающий список */
    .select2-dropdown {
        border: 1px solid #e1e1e1 !important;
        border-radius: 0 !important;
        border-top: none !important;
    }

    /* Опции в списке */
    .select2-results__option {
        padding: 10px 15px !important;
        font-size: 16px !important;
    }

    /* Наведение на опцию */
    .select2-results__option--highlighted[aria-selected] {
        background-color: #337d5a !important;
        color: white !important;
    }

    /* Выбранная опция */
    .select2-results__option[aria-selected="true"] {
        background-color: #f0f0f0 !important;
        color: #333 !important;
    }

    /* Disabled состояние */
    .select2-container--default .select2-selection--single.select2-selection--disabled {
        background-color: #e9ecef !important;
        cursor: not-allowed !important;
    }

    /* Поиск внутри селекта */
    .select2-search--dropdown .select2-search__field {
        border: 1px solid #e1e1e1 !important;
        border-radius: 0 !important;
        padding: 8px 12px !important;
        font-size: 14px !important;
    }

    .select2-search--dropdown .select2-search__field:focus {
        border-color: #337d5a !important;
        outline: none !important;
    }

    /* Убираем всплывающую подсказку title */
    .select2-container .select2-selection--single .select2-selection__rendered {
        pointer-events: none;
    }


    /* ========================================
       ОСТАЛЬНЫЕ СТИЛИ ФОРМЫ
    ======================================== */

    .physical-only {
        display: block;
    }

    .legal-only {
        display: none;
    }

    /* Аватар */
    .avatar-wrapper {
        background-color: #7ba090;
        height: 200px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
        cursor: pointer;
        margin-bottom: 20px;
        transition: all 0.3s ease;
    }

    .avatar-wrapper:hover {
        background-color: #6a9080;
    }

    /* Табы */
    .registration-tabs {
        border-bottom: 1px solid #e1e1e1;
        display: flex;
        gap: 40px;
        margin-bottom: 2rem !important;
    }

    .reg-tab {
        padding: 10px 0;
        background: none;
        border: none;
        font-weight: 700;
        cursor: pointer;
        margin-bottom: -2px;
        transition: all 0.3s ease;
    }

    .reg-tab:hover {
        color: #337d5a !important;
    }

    /* Форма */
    .form-control {
        height: 50px;
        border: 1px solid #e1e1e1;
        border-radius: 0;
        padding: 15px;
        font-size: 16px;
    }

    .form-control:focus {
        border-color: #337d5a;
        box-shadow: 0 0 0 0.2rem rgba(51, 125, 90, 0.25);
    }

    .button {
        background-color: #337d5a;
        color: white;
        font-weight: 700;
        transition: all 0.3s ease;
    }

    .button:hover {
        background-color: #2a6549;
    }
</style>
{% endblock %}

{% block content %}
<section class="section" style="padding: 60px 0;">
    <div class="container">
        <h2 class="mb-5" style="font-weight: 800; color: #1d252d;">Регистрация</h2>

        <form method="post" class="register-form" enctype="multipart/form-data" autocomplete="off">
            {% csrf_token %}

            {# Ловушка автозаполнения #}
            <div style="position:absolute; left:-9999px; top: -9999px;">
                <input type="text" name="fake_username_trap" tabindex="-1">
                <input type="password" name="fake_password_trap" tabindex="-1">
            </div>

            <input type="hidden" name="user_type" id="id_user_type" value="physical">

            {# ТАБЫ #}
            <div class="registration-tabs">
                <button type="button" class="reg-tab active" data-type="physical"
                        style="color: #1d252d; border-bottom: 3px solid #337d5a;">
                    Физическое лицо
                </button>
                <button type="button" class="reg-tab" data-type="legal"
                        style="color: #aaa; border-bottom: 3px solid transparent;">
                    Юридическое лицо
                </button>
            </div>

            {# Вывод ошибок формы #}
            {% if form.errors %}
            <div class="alert alert-danger mb-4">
                <strong>Пожалуйста, исправьте следующие ошибки:</strong>
                <ul class="mb-0 mt-2">
                    {% for field, errors in form.errors.items %}
                        {% for error in errors %}
                            <li>{{ field }}: {{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <div class="row">
                {# --- ЛЕВАЯ КОЛОНКА --- #}
                <div class="col-lg-8 col-12">
                    <h4 class="mb-4" style="font-weight: 700;">1. Контактные данные</h4>

                    <div class="form-group mb-3">
                        <input type="text" name="first_name" class="form-control"
                               placeholder="Имя *" required
                               value="{{ form.first_name.value|default:'' }}">
                    </div>

                    <div class="form-group mb-3">
                        <input type="text" name="last_name" class="form-control"
                               placeholder="Фамилия *"
                               value="{{ form.last_name.value|default:'' }}">
                    </div>

                    <div class="form-group mb-3">
                        <input type="text" name="middle_name" class="form-control"
                               placeholder="Отчество"
                               value="{{ form.middle_name.value|default:'' }}">
                    </div>

                    <div class="form-group mb-3">
                        <input type="email" name="email" class="form-control"
                               placeholder="Email *" required
                               value="{{ form.email.value|default:'' }}">
                    </div>

                    <div class="form-group mb-3">
                        <input type="text" name="phone" id="id_phone" class="form-control"
                               placeholder="Телефон (например: +38 067 123 45 67) *" required
                               value="{{ form.phone.value|default:'' }}">
                    </div>

                    <div class="form-group mb-5">
                        <input type="text" name="username" class="form-control"
                               placeholder="Логин *" required
                               value="{{ form.username.value|default:'' }}">
                    </div>

                    <h4 class="mb-4" style="font-weight: 700;">2. Адрес</h4>

                    <div class="form-group mb-3" id="country-wrapper" data-api-url="/users/api/regions">
                        {{ form.country }}
                    </div>

                    <div class="form-group mb-3" id="region-wrapper">
                        {{ form.region }}
                    </div>

                    <div class="form-group mb-3">
                        <input type="text" name="city" class="form-control"
                               placeholder="Город *" required
                               value="{{ form.city.value|default:'' }}">
                    </div>

                    <div class="form-group mb-3">
                        <input type="text" name="address_line" class="form-control"
                               placeholder="Адрес (улица, дом, квартира)"
                               value="{{ form.address_line.value|default:'' }}">
                    </div>

                    <div class="form-group mb-5">
                        <input type="text" name="zip_code" class="form-control"
                               placeholder="Почтовый индекс"
                               value="{{ form.zip_code.value|default:'' }}">
                    </div>

                    <h4 class="mb-4" style="font-weight: 700;">3. Пароль</h4>

                    <div class="form-group mb-3">
                        <input type="password" name="password1" class="form-control"
                               placeholder="Пароль *" required autocomplete="new-password">
                    </div>

                    <div class="form-group mb-4">
                        <input type="password" name="password2" class="form-control"
                               placeholder="Подтвердите пароль *" required autocomplete="new-password">
                    </div>

                    <div class="form-check mb-4">
                        <input type="checkbox" class="form-check-input" id="agree" required>
                        <label class="form-check-label" for="agree">
                            Я согласен с <a href="#" style="color: #337d5a;">Условиями регистрации</a>
                        </label>
                    </div>

                    <div class="form-group">
                        <button type="submit" class="button" style="width: 100%; border: none; padding: 15px;">
                            Зарегистрироваться
                        </button>
                    </div>
                </div>

                {# --- ПРАВАЯ КОЛОНКА --- #}
                <div class="col-lg-3 offset-lg-1 col-12 mt-4 mt-lg-0">
                    <label for="id_avatar" style="cursor: pointer; width: 100%; display: block;">
                        <div class="avatar-wrapper" id="avatarBox">
                            <img id="avatar-placeholder" src="{% static 'img/pic.png' %}"
                                 style="width: 100%; height: 100%; object-fit: cover;">
                            <img id="avatar-preview-img" src=""
                                 style="display: none; width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0;">
                        </div>
                        <input type="file" name="avatar" id="id_avatar" style="display: none;" accept="image/*">
                    </label>

                    <div id="fop-block" class="mt-3 physical-only">
                        <div class="form-check">
                            <input type="checkbox" name="is_fop" id="id_is_fop" class="form-check-input">
                            <label class="form-check-label" for="id_is_fop">Являюсь ФОП</label>
                        </div>
                    </div>

                    <div id="requisitesBlock" class="mt-4" style="display: none;">
                        <h4 style="font-weight: 700; font-size: 18px; margin-bottom: 15px;">Реквизиты</h4>

                        <div class="form-group mb-3">
                            <input type="text" name="company_name" id="id_company_name"
                                   class="form-control" placeholder="Название компании / ФИО ФОП"
                                   style="padding: 10px; height: auto;"
                                   value="{{ form.company_name.value|default:'' }}">
                        </div>

                        <div class="form-group mb-3">
                            <input type="text" name="okpo" id="id_okpo"
                                   class="form-control" placeholder="ОКПО / ЕДРПОУ"
                                   style="padding: 10px; height: auto;"
                                   value="{{ form.okpo.value|default:'' }}">
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="{% static 'js/registration.js' %}"></script>
{% endblock %}
