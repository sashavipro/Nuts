{% load wagtailcore_tags static wagtailimages_tags %}

<section class="news-section section">
    <div class="container">
        {# --- ШАПКА БЛОКА --- #}
        <div class="row align-items-end mb-4 mb-md-5">
            <div class="col-md-8 col-12">
                <h2 class="section-title">{{ self.title }}</h2>
                {% if self.subtitle %}
                    <p class="section-subtitle">{{ self.subtitle }}</p>
                {% endif %}
            </div>

            <div class="col-md-4 col-12 d-flex justify-content-md-end justify-content-start mt-3 mt-md-0">
                <div class="news-navigation">
                    <div class="nav-btn nav-prev">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M19 12H5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M12 19L5 12L12 5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="nav-btn nav-next">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M5 12H19" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M12 5L19 12L12 19" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        {# --- СЛАЙДЕР --- #}
        <div class="news-slider-wrapper">
            <div class="news-container swiper-container">
                <div class="swiper-wrapper">
                    {% for post in news_items %}
                    <div class="swiper-slide">
                        <div class="news-card h-100 d-flex flex-column">

                            {# --- 1. МЕДИА БЛОК (Вся область - это ссылка на новость) --- #}
                            <a href="{% pageurl post %}" class="news-card__image position-relative d-block">

                                {# ВИДЕО (Autoplay Muted Loop - работает как GIF) #}
                                {% if post.preview_video %}
                                    <video autoplay muted loop playsinline
                                           style="width: 100%; height: 100%; object-fit: cover; display: block; opacity: 0.9;">
                                        <source src="{{ post.preview_video.url }}" type="video/mp4">
                                    </video>

                                {# КАРТИНКА #}
                                {% elif post.preview_image %}
                                    {% image post.preview_image fill-370x250 style="width: 100%; height: 100%; object-fit: cover; display: block;" %}
                                {% else %}
                                    <img src="{% static 'img/placeholder.jpg' %}" style="width: 100%; height: 100%; object-fit: cover; display: block;">
                                {% endif %}

                                {# ОВЕРЛЕЙ (Если текст или видео поверх) #}
                                {% if post.preview_video or post.show_text_on_preview %}
                                    <div class="video-ui-layer" style="position: absolute; top:0; left:0; width:100%; height:100%;">

                                        {# Затемнение фона #}
                                        <div class="overlay" style="position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.3); transition: opacity 0.3s;"></div>

                                        <div class="center-content" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; width: 90%; z-index: 10;">

                                            {# Иконка Play (декоративная) #}
                                            {% if post.preview_video %}
                                                <div class="play-btn mb-3">
                                                    <i class="nut-icon icons-play-icon" style="font-size: 50px; color: #fff; text-shadow: 0 2px 10px rgba(0,0,0,0.3);"></i>
                                                </div>
                                            {% endif %}

                                            {# Текст поверх #}
                                            {% if post.show_text_on_preview %}
                                                <h3 class="mb-2" style="color: #fff; font-weight: 800; font-size: 18px; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">
                                                    {{ post.title }}
                                                </h3>
                                                {% if post.intro %}
                                                    <div class="preview-intro" style="color: rgba(255,255,255,0.9); font-size: 14px; font-weight: 500; text-shadow: 0 1px 3px rgba(0,0,0,0.5);">
                                                        {{ post.intro|truncatechars:80 }}
                                                    </div>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endif %}
                            </a>

                            {# --- 2. КОНТЕНТ КАРТОЧКИ СНИЗУ --- #}
                            <div class="news-card__body d-flex flex-column flex-grow-1">
                                <div class="news-card__date">{{ post.date|date:"d.m.Y" }}</div>

                                {# Если текст НЕ поверх превью -> выводим его здесь #}
                                {% if not post.show_text_on_preview %}
                                    <h3 class="news-card__title">
                                        <a href="{% pageurl post %}">{{ post.title }}</a>
                                    </h3>
                                    {% if post.intro %}
                                        <p class="news-card__text">{{ post.intro|truncatechars:100 }}</p>
                                    {% endif %}
                                {% endif %}

                                <div class="mt-auto pt-3">
                                    <a href="{% pageurl post %}" class="news-card__link">
                                        Читать
                                        <svg width="18" height="12" viewBox="0 0 18 12" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-left: 5px;">
                                            <path d="M1 6H17" stroke="#337D5A" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M12 1L17 6L12 11" stroke="#337D5A" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                        <div class="col-12 text-center text-muted">Новостей пока нет.</div>
                    {% endfor %}
                </div>
            </div>
        </div>

        {% if self.news_index_page %}
        <div class="row mt-5">
            <div class="col-12 text-center">
                <a href="{% pageurl self.news_index_page %}" class="btn-news-all">
                    Смотреть все новости
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</section>

{# --- СТИЛИ (CSS) --- #}
<style>
    .news-section { padding: 60px 0; background-color: #fff; }
    .section-title { font-weight: 800; font-size: 36px; color: #1A2F3F; margin-bottom: 10px; }
    .section-subtitle { color: #555; font-size: 16px; }

    /* Навигация */
    .news-navigation { display: flex; background-color: #337D5A; border-radius: 4px; overflow: hidden; }
    .nav-btn { width: 60px; height: 50px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.3s; border-left: 1px solid rgba(255,255,255,0.2); }
    .nav-btn:first-child { border-left: none; }
    .nav-btn:hover { background-color: #2a6649; }
    .nav-btn.swiper-button-disabled { opacity: 0.5; cursor: default; }

    /* Карточка */
    .news-card__image {
        overflow: hidden;
        border-radius: 8px 8px 0 0;
        margin-bottom: 20px;
        height: 240px;
        background-color: #000;
        text-decoration: none; /* Убираем подчеркивание для ссылки-обертки */
    }
    .news-card__image img, .news-card__image video { transition: transform 0.3s; }

    /* Эффект наведения */
    .news-card__image:hover img,
    .news-card__image:hover video {
        transform: scale(1.05);
    }
    .news-card__image:hover .overlay {
        background: rgba(0,0,0,0.5) !important;
    }
    .news-card__image:hover .icons-play-icon {
        transform: scale(1.1);
        transition: 0.3s;
    }

    .news-card__date { font-size: 13px; color: #999; margin-bottom: 10px; }
    .news-card__title { font-size: 18px; font-weight: 700; line-height: 1.4; margin-bottom: 10px; }
    .news-card__title a { color: #1A2F3F; text-decoration: none; }
    .news-card__text { font-size: 14px; color: #555; line-height: 1.5; margin-bottom: 10px; }
    .news-card__link { display: inline-flex; align-items: center; color: #337D5A; font-weight: 700; text-decoration: none; font-size: 14px; transition: gap 0.3s; }
    .news-card__link:hover { color: #2a6649; gap: 5px; }

    .btn-news-all { display: inline-block; padding: 12px 30px; border: 1px solid #337D5A; color: #337D5A; font-weight: 600; text-decoration: none; transition: all 0.3s; }
    .btn-news-all:hover { background-color: #337D5A; color: #fff; }
</style>

{# --- СКРИПТ (JS) - Только инициализация слайдера --- #}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var section = document.querySelector('.news-section');
        if(section) {
            new Swiper(section.querySelector('.news-container'), {
                slidesPerView: 3,
                spaceBetween: 30,
                loop: false,
                autoplay: false, // Автопрокрутка слайдера отключена
                navigation: {
                    nextEl: section.querySelector('.nav-next'),
                    prevEl: section.querySelector('.nav-prev'),
                },
                breakpoints: {
                    320: { slidesPerView: 1, spaceBetween: 15 },
                    768: { slidesPerView: 2, spaceBetween: 30 },
                    1024: { slidesPerView: 3, spaceBetween: 30 }
                }
            });
        }
    });
</script>
