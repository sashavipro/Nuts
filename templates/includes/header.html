{% load i18n django_vite wagtailcore_tags wagtailimages_tags navigation_tags wagtailsettings_tags i18n_tags %}
{% get_settings %}

<header class="top-header">
    <div class="top-header__line">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-4 col-12 d-lg-block d-none">
                    <ul class="line_social">
                        {% for link in settings.core.SiteSettings.social_links.all %}
                            {% if link.link_type == 'social' %}
                                <li><a href="{{ link.url }}" target="_blank"><i class="nut-icon icons-{{ link.platform }}"></i></a></li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                </div>
                <div class="col-lg-4 col-12 d-lg-flex d-none justify-content-center">
                    <p>{{ settings.core.SiteSettings.discount_text }}</p>
                </div>
                <div class="col-lg-4 col-12">
                    <div class="wrap">
                        <ul class="log_in d-lg-flex d-none">
                            {% if user.is_authenticated %}
                                <li>
                                    <a href="{% get_profile_url %}">
                                        <i class="nut-icon icons-man-user"></i>
                                        <span>{{ user.first_name|default:user.username }}</span>
                                    </a>
                                </li>
                                <li>
                                    <form id="logout-form" action="{% url 'logout' %}" method="post" style="display: none;">
                                        {% csrf_token %}
                                    </form>
                                    <a href="#" onclick="event.preventDefault(); document.getElementById('logout-form').submit();">
                                        <span>{% trans "Выход" %}</span>
                                    </a>
                                </li>
                            {% else %}
                                <li>
                                    <a href="{% url 'login' %}">
                                        <i class="nut-icon icons-man-user"></i>
                                        <span>{% trans "Вход" %}</span>
                                    </a>
                                </li>
                                <li>
                                    <a href="{% url 'register' %}">
                                        <span>{% trans "Регистрация" %}</span>
                                    </a>
                                </li>
                            {% endif %}
                        </ul>

                        <div id="lang-menu" class="lang-menu">
                            <span class="title">{{ request.LANGUAGE_CODE|upper }}</span>
                            <ul>
                                <li>
                                    <a href="{% get_translated_url 'en' %}" {% if request.LANGUAGE_CODE == 'en' %}class="active"{% endif %}>En</a>
                                </li>
                                <li>
                                    <a href="{% get_translated_url 'ru' %}" {% if request.LANGUAGE_CODE == 'ru' %}class="active"{% endif %}>Ru</a>
                                </li>
                                <li>
                                    <a href="{% get_translated_url 'uk' %}" {% if request.LANGUAGE_CODE == 'uk' %}class="active"{% endif %}>Uk</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="top-header__logo">
        <div class="container">
            <div class="row">
                <div class="col-2 d-lg-none">
                    <div class="mobile-menu-button d-lg-none d-block"><img src="{% vite_asset_url 'app/img/menu.svg' %}" alt="menu"></div>
                </div>
                <div class="col-xl-4 col-lg-3 col-8 align-self-center">
                    <a href="/" class="logo">
                        {% if settings.core.SiteSettings.logo %}
                            {% image settings.core.SiteSettings.logo original %}
                        {% else %}
                            <img src="{% vite_asset_url 'app/img/logo.png' %}" alt="logo">
                        {% endif %}
                        <span>{{ settings.core.SiteSettings.logo_text|safe }}</span>
                    </a>
                </div>
                <div class="col-xl-8 col-lg-9 col-2 align-self-center">
                    <div class="row">
                        <div class="col-lg-6 col-12 align-self-center d-lg-block d-none">
                            <div class="wrap">
                                <ul class="logo_social">
                                    {% for link in settings.core.SiteSettings.social_links.all %}
                                        {% if link.link_type == 'messenger' %}
                                            <li><a href="{{ link.url }}" target="_blank"><i class="nut-icon icons-{{ link.platform }}"></i></a></li>
                                        {% endif %}
                                    {% endfor %}
                                </ul>
                                <ul class="logo_tel">
                                    {% if settings.core.SiteSettings.phone_1_number %}
                                    <li><a href="tel:{{ settings.core.SiteSettings.phone_1_code|cut:' '|cut:'('|cut:')' }}{{ settings.core.SiteSettings.phone_1_number|cut:'-' }}"><span>{{ settings.core.SiteSettings.phone_1_code }}</span> {{ settings.core.SiteSettings.phone_1_number }}</a></li>
                                    {% endif %}
                                    {% if settings.core.SiteSettings.phone_2_number %}
                                    <li><a href="tel:{{ settings.core.SiteSettings.phone_2_code|cut:' '|cut:'('|cut:')' }}{{ settings.core.SiteSettings.phone_2_number|cut:'-' }}"><span>{{ settings.core.SiteSettings.phone_2_code }}</span> {{ settings.core.SiteSettings.phone_2_number }}</a></li>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                        <div class="col-lg-6 col-12 align-self-center">
                            <div class="wraper">
                                <ul class="logo_tel_mobile d-lg-none d-flex">
                                    {% if settings.core.SiteSettings.phone_1_number %}
                                    <li><a href="tel:{{ settings.core.SiteSettings.phone_1_code|cut:' '|cut:'('|cut:')' }}{{ settings.core.SiteSettings.phone_1_number|cut:'-' }}"><span>{{ settings.core.SiteSettings.phone_1_code }}</span> {{ settings.core.SiteSettings.phone_1_number }}</a></li>
                                    {% endif %}
                                </ul>
                                <ul class="logo_button_mobile d-lg-none d-flex">
                                    <li><a href="#" class="button">{% trans "Заказать звонок" %}</a></li>
                                </ul>
                                <ul class="logo_button d-lg-flex d-none">
                                    <li><a href="#" class="button">{% trans "Заказать звонок" %}</a></li>
                                    <li><p>{{ settings.core.SiteSettings.call_text|safe }}</p></li>
                                </ul>

                                <div class="cart-wrapper" style="position: relative; display: flex; align-items: center;">
                                    <a href="{% get_cart_url %}" class="logo_number" id="cart-dropdown-trigger" onclick="event.preventDefault(); document.getElementById('mini-cart-container').classList.toggle('show');">
                                        <i class="nut-icon icons-number"></i>
                                        <span id="cart-counter" class="quantity" hx-get="/shop/api/cart/count/" hx-trigger="load, cartUpdated from:body">0</span>
                                    </a>

                                    <div id="mini-cart-container" class="mini-cart-dropdown" hx-get="/shop/api/cart/mini/" hx-trigger="load, cartUpdated from:body">
                                    </div>
                                </div>
                                </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="top-header__discount d-lg-none d-flex">
        <p>{{ settings.core.SiteSettings.discount_text }}</p>
    </div>
    <div class="top-header__menu d-lg-flex d-none">
        <div class="container">
            <div class="row">
                <nav class="menu_main menu_top">
                    <div class="mobile-line d-lg-none d-flex"></div>

                    {% get_top_menu as menu_items %}

                    <ul class="menu_main_ul">
                        {% for item in menu_items %}
                            <li>
                                <a href="{% pageurl item %}" class="{% if item.id == request.current_page.id %}active{% endif %}">
                                    {{ item.title }}
                                </a>
                            </li>
                        {% endfor %}
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</header>

<style>
    .mini-cart-dropdown {
        position: absolute;
        top: calc(100% + 15px); /* Отступ от иконки */
        right: 0;
        width: 480px; /* Достаточная ширина для макета */
        background: #fff;
        border: 2px solid #3d8063; /* Зеленая рамка */
        z-index: 9999;
        display: none;
        padding: 20px 30px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    .mini-cart-dropdown.show { display: block; }

    /* Делаем небольшой невидимый мостик, чтобы меню не пропадало, пока ведешь мышку (опционально) */
    .mini-cart-dropdown::before {
        content: '';
        position: absolute;
        top: -15px;
        right: 0;
        width: 100%;
        height: 15px;
        background: transparent;
    }

    /* Элемент товара в списке */
    .mc-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 15px 0;
        border-bottom: 1px solid #f4f4f4;
    }

    .mc-title {
        font-size: 16px;
        color: #1a2f3a;
        flex: 1;
        padding-right: 15px;
        font-weight: 500;
    }

    /* Блок с кнопками количества */
    .mc-qty-controls {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-right: 25px;
    }
    .mc-qty-controls button {
        background: none;
        border: none;
        font-size: 16px;
        color: #888;
        cursor: pointer;
        padding: 0 5px;
        transition: color 0.2s;
        font-family: monospace; /* Чтобы стрелочки < > были ровными */
    }
    .mc-qty-controls button:hover {
        color: #3d8063;
    }
    .mc-qty-controls input {
        width: 45px;
        text-align: center;
        border: 1px solid #e5e5e5;
        height: 34px;
        font-size: 15px;
        color: #1a2f3a;
        pointer-events: none;
        outline: none;
    }

    /* Цена */
    .mc-price {
        font-size: 16px;
        color: #1a2f3a;
        min-width: 80px;
        text-align: left;
    }

    /* Крестик удаления */
    .mc-remove {
        background: none;
        border: none;
        color: #b0b0b0;
        font-size: 20px;
        cursor: pointer;
        padding: 0 5px;
        transition: color 0.2s;
        display: flex;
        align-items: center;
    }
    .mc-remove:hover { color: #ff4d4d; }

    /* Футер (Всего + Кнопка) */
    .mc-footer {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 30px;
        margin-top: 25px;
        padding-top: 5px;
    }

    .mc-total {
        font-size: 18px;
        color: #1a2f3a;
        font-weight: 700;
        display: flex;
        align-items: baseline;
    }
    .mc-total-sum {
        font-size: 26px;
        color: #3d8063;
        margin: 0 5px;
        font-weight: 800;
    }
    .mc-total-currency {
        font-size: 16px;
        color: #3d8063;
        font-weight: 700;
    }

    /* Кнопка "Перейти в корзину" */
    .mc-checkout-btn {
        padding: 12px 25px;
        font-size: 15px;
        cursor: pointer;
        color: #fff;
        background-color: #3d8063;
        border: none;
        text-decoration: none;
        font-weight: 600;
        transition: background-color 0.2s;
    }
    .mc-checkout-btn:hover { background-color: #2a664a; color: #fff;}

    .mc-empty { text-align: center; padding: 20px; color: #888; }

    @media (max-width: 767px) {
        .mini-cart-dropdown {
            position: fixed;
            top: 70px; /* Высота мобильного хедера */
            right: 15px;
            left: 15px;
            width: auto;
        }
    }
</style>

<script>
    document.addEventListener('click', function(event) {
        var trigger = document.getElementById('cart-dropdown-trigger');
        var container = document.getElementById('mini-cart-container');
        if (trigger && container) {
            var isClickInside = trigger.contains(event.target) || container.contains(event.target);
            if (!isClickInside) {
                container.classList.remove('show');
            }
        }
    });
</script>
